(function(l,d){typeof exports=="object"&&typeof module!="undefined"?d(exports):typeof define=="function"&&define.amd?define(["exports"],d):(l=typeof globalThis!="undefined"?globalThis:l||self,d(l.BrowserCache={}))})(this,function(l){"use strict";var J=Object.defineProperty;var U=(l,d,S)=>d in l?J(l,d,{enumerable:!0,configurable:!0,writable:!0,value:S}):l[d]=S;var u=(l,d,S)=>(U(l,typeof d!="symbol"?d+"":d,S),S);var d={driver:"memory"};function S(i){return{all:i=i||new Map,on:function(r,e){var s=i.get(r);s?s.push(e):i.set(r,[e])},off:function(r,e){var s=i.get(r);s&&(e?s.splice(s.indexOf(e)>>>0,1):i.set(r,[]))},emit:function(r,e){var s=i.get(r);s&&s.slice().map(function(t){t(e)}),(s=i.get("*"))&&s.slice().map(function(t){t(r,e)})}}}class j{constructor(){u(this,"mitt",new S)}get all(){return this.mitt.all}$on(){return this.mitt.on.apply(this,arguments)}$off(){return this.mitt.off.apply(this,arguments)}$emit(){return this.mitt.emit.apply(this,arguments)}}class v extends j{constructor(e={}){super();u(this,"opts");u(this,"isReady",!1);this.opts=e,this.isReady=!1}existsKey(){throw new Error("please implement the existsKey method for this driver.")}get(){throw new Error("please implement the get method for this driver.")}set(){throw new Error("please implement the set method for this driver.")}}const p={OK:Symbol("OK"),KEY_NOT_EXISTS:Symbol("KEY_NOT_EXISTS"),KEY_EXPIRED:Symbol("KEY_EXPIRED"),JSON_PARSE_ERROR:Symbol("JSON_PARSE_ERROR"),NX_SET_NOT_PERFORMED:Symbol("NX_SET_NOT_PERFORMED"),XX_SET_NOT_PERFORMED:Symbol("XX_SET_NOT_PERFORMED")};class E extends v{constructor(r){super(r),this.isReady=!0,this.$emit("ready")}keyValueGet(){throw new Error("please implement the keyValueGet method for this driver.")}keyValueSet(){throw new Error("please implement the keyValueSet method for this driver.")}existsKey(){throw new Error("please implement the existsKey method for this driver.")}get(r){const e=this.keyValueGet(r);if(e)try{const s=JSON.parse(e);if(s.expiredAt){if(s.expiredAt>Date.now())return s.value;this.$emit("cacheExpired",r);return}else return s.value}catch(s){window.console.debug("get key json parse error",s);return}}set(r,e,s={}){const{EX:t,PX:o,EXAT:n,PXAT:a,NX:h=!1,XX:w=!1,GET:f=!1}=s;let c,b;if(t&&typeof t=="number"&&t>0&&(c=Date.now()+t*1e3),o&&typeof o=="number"&&o>0&&(c=Date.now()+o),n&&typeof n=="number"&&n>0&&(c=n*1e3),a&&typeof a=="number"&&a>0&&(c=a),c&&(b=Math.max(c-Date.now(),0)),h||w||f){const m=this.get(r),g=this.existsKey(r);return h&&g?f?m:p.NX_SET_NOT_PERFORMED:w&&!g?f?m:p.XX_SET_NOT_PERFORMED:(this.keyValueSet(r,JSON.stringify({value:e,expiredAt:c,maxAge:b})),f?m:p.OK)}else return this.keyValueSet(r,JSON.stringify({value:e,expiredAt:c,maxAge:b})),p.OK}}class C extends E{keyValueGet(r){return localStorage.getItem(r)}keyValueSet(r,e){localStorage.setItem(r,e)}existsKey(r){return!!localStorage.getItem(r)}}u(C,"driver","localStorage");class P extends E{constructor(){super(...arguments);u(this,"data",new Map)}keyValueGet(e){return this.data.get(e)}keyValueSet(e,s){this.data.set(e,s)}existsKey(e){return!!this.data.has(e)}}u(P,"driver","memory");class T extends E{keyValueGet(r){return sessionStorage.getItem(r)}keyValueSet(r,e){sessionStorage.setItem(r,e)}existsKey(r){return!!sessionStorage.getItem(r)}}u(T,"driver","sessionStorage");/*! js-cookie v3.0.1 | MIT */function x(i){for(var r=1;r<arguments.length;r++){var e=arguments[r];for(var s in e)i[s]=e[s]}return i}var B={read:function(i){return i[0]==='"'&&(i=i.slice(1,-1)),i.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent)},write:function(i){return encodeURIComponent(i).replace(/%(2[346BF]|3[AC-F]|40|5[BDE]|60|7[BCD])/g,decodeURIComponent)}};function D(i,r){function e(t,o,n){if(typeof document!="undefined"){n=x({},r,n),typeof n.expires=="number"&&(n.expires=new Date(Date.now()+n.expires*864e5)),n.expires&&(n.expires=n.expires.toUTCString()),t=encodeURIComponent(t).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape);var a="";for(var h in n)!n[h]||(a+="; "+h,n[h]!==!0&&(a+="="+n[h].split(";")[0]));return document.cookie=t+"="+i.write(o,t)+a}}function s(t){if(!(typeof document=="undefined"||arguments.length&&!t)){for(var o=document.cookie?document.cookie.split("; "):[],n={},a=0;a<o.length;a++){var h=o[a].split("="),w=h.slice(1).join("=");try{var f=decodeURIComponent(h[0]);if(n[f]=i.read(w,f),t===f)break}catch{}}return t?n[t]:n}}return Object.create({set:e,get:s,remove:function(t,o){e(t,"",x({},o,{expires:-1}))},withAttributes:function(t){return D(this.converter,x({},this.attributes,t))},withConverter:function(t){return D(x({},this.converter,t),this.attributes)}},{attributes:{value:Object.freeze(r)},converter:{value:Object.freeze(i)}})}var N=D(B,{path:"/"});class V extends E{keyValueGet(r){return N.get(r)}keyValueSet(r,e){N.set(r,e)}existsKey(r){return!!N.get(r)}}u(V,"driver","cookie");class X extends v{constructor(r){super(r)}keyValueGet(){return Promise.reject(new Error("please implement the keyValueGet method for this driver."))}keyValueSet(){return Promise.reject(new Error("please implement the keyValueSet method for this driver."))}existsKey(){return Promise.reject(new Error("please implement the existsKey method for this driver."))}get(r){return new Promise((e,s)=>{this.keyValueGet(r).then(t=>{if(t)try{const o=JSON.parse(t);o.expiredAt?o.expiredAt>Date.now()?e(o.value):(this.$emit("cacheExpired",r),e()):e(o.value)}catch(o){window.console.debug("get key json parse error",o),e()}else e()}).catch(t=>{s(t)})})}set(r,e,s={}){const{EX:t,PX:o,EXAT:n,PXAT:a,NX:h=!1,XX:w=!1,GET:f=!1}=s;let c,b;return t&&typeof t=="number"&&t>0&&(c=Date.now()+t*1e3),o&&typeof o=="number"&&o>0&&(c=Date.now()+o),n&&typeof n=="number"&&n>0&&(c=n*1e3),a&&typeof a=="number"&&a>0&&(c=a),c&&(b=Math.max(c-Date.now(),0)),new Promise((m,g)=>{if(h||w||f){const R=this.get(r),M=this.existsKey(r);Promise.all([R,M]).then(([O,A])=>{if(h&&A)return m(f?O:p.NX_SET_NOT_PERFORMED);if(w&&!A)return m(f?O:p.XX_SET_NOT_PERFORMED);this.keyValueSet(r,JSON.stringify({value:e,expiredAt:c,maxAge:b})).then(()=>m(f?O:p.OK)).catch(F=>{g(F)})}).catch(O=>{g(O)})}else this.keyValueSet(r,JSON.stringify({value:e,expiredAt:c,maxAge:b})).then(()=>m(p.OK)).catch(R=>{g(R)})})}}class k extends X{constructor(e){var s,t,o;super(e);u(this,"dbName","browser-cache");u(this,"objectStoreName","browser-cache");u(this,"dbVersion",1);u(this,"dbConnection");this.isReady=!1,(s=this.opts)!=null&&s.dbName&&(this.dbName=this.opts.dbName),(t=this.opts)!=null&&t.objectStoreName&&(this.objectStoreName=this.opts.objectStoreName),(o=this.opts)!=null&&o.dbVersion&&(this.dbVersion=this.opts.dbVersion),this.connectDB().then(()=>{this.initObjectStore()})}connectDB(){return new Promise((e,s)=>{const t=window.indexedDB.open(this.dbName,this.dbVersion);t.onerror=()=>{window.console.error(`Database ${this.dbName} init occurs error`,t.result),s(t.result)},t.onsuccess=()=>{this.dbConnection=t.result,window.console.debug(`Database ${this.dbName} initialised.`),e(this.dbConnection)},t.onupgradeneeded=o=>{this.dbConnection=o.target.result,window.console.debug("Database version upgraded success."),e(this.dbConnection)}})}initObjectStore(){return new Promise((e,s)=>{if(this.dbConnection)this.dbConnection.objectStoreNames.contains(this.objectStoreName)||this.dbConnection.createObjectStore(this.objectStoreName,{keyPath:"key"}),this.isReady=!0,this.$emit("ready"),e();else{const t=new Error(`Database ${this.dbName} connection is not initialised.`);window.console.error(t),s(t)}})}keyValueGet(e){return new Promise((s,t)=>{if(this.dbConnection){const o=this.dbConnection.transaction([this.objectStoreName],"readonly").objectStore(this.objectStoreName).get(e);o.onerror=()=>{window.console.error("Database keyValueGet occurs error",o.result),t(o.result)},o.onsuccess=()=>{var n;s((n=o.result)==null?void 0:n.value)}}else{const o=new Error(`Database ${this.dbName} connection is not initialised.`);window.console.error(o),t(o)}})}keyValueSet(e,s){return new Promise((t,o)=>{if(this.dbConnection){const n=this.dbConnection.transaction([this.objectStoreName],"readwrite").objectStore(this.objectStoreName).put({key:e,value:s});n.onerror=()=>{window.console.error("Database keyValueSet occurs error",n.result),o(n.result)},n.onsuccess=()=>{var a;t((a=n.result)==null?void 0:a.value)}}else{const n=new Error(`Database ${this.dbName} connection is not initialised.`);window.console.error(n),o(n)}})}existsKey(e){return new Promise((s,t)=>{if(this.dbConnection){const o=this.dbConnection.transaction([this.objectStoreName],"readonly").objectStore(this.objectStoreName).count(e);o.onerror=()=>{window.console.error("Database existsKey occurs error",o.result),t(o.result)},o.onsuccess=()=>{s(!!o.result)}}else{const o=new Error(`Database ${this.dbName} connection is not initialised.`);window.console.error(o),t(o)}})}}u(k,"driver","indexedDB");const y={};for(const i of[P,C,T,V,k])y[i.driver]=i;const _={},I=i=>{if(Object.getPrototypeOf(i)===v)if(i.driver&&typeof i.driver=="string")_[i.driver]=i;else throw new Error("please input the driver name.")},K=()=>{let i=["memory"];return window.localStorage&&y.localStorage&&i.push("localStorage"),window.sessionStorage&&y.sessionStorage&&i.push("sessionStorage"),window.document.cookie&&y.cookie&&i.push("cookie"),window.indexedDB&&y.indexedDB&&i.push("indexedDB"),i=i.concat(Object.keys(_)),i},$=i=>y[i]||_[i];class G extends j{constructor(e,s){super();u(this,"opts");u(this,"__init",!1);u(this,"driver");u(this,"store");const t=K();if(!e&&!s)s={...d};else if(e)if(t.includes(e))Object.prototype.toString.call(s)==="[object Object]"?s={...d,driver:e,...s}:s={...d,driver:e};else if(Object.prototype.toString.call(e)==="[object Object]"&&t.includes(e.driver))s={...d,...e};else throw new Error("please input the correct driver param as the first param or in the opts params.");else throw new Error("please input the driver as first param.");if(s&&s.driver)this.opts=s,this.initDriver();else throw new Error("please input the driver as first param.")}initDriver(){const e=K();if(this.opts&&this.opts.driver&&e.includes(this.opts.driver)){this.__init=!1;const s=$(this.opts.driver);this.store=new s(this.opts),this.store.$on("ready",()=>{this.__init=!0,this.driver=this.opts.driver,this.$emit("ready")})}}setDriver(e){this.opts.driver=e,this.initDriver()}existsKey(){return this.store.existsKey.apply(this.store,arguments)}get(){return this.store.get.apply(this.store,arguments)}set(){return this.store.set.apply(this.store,arguments)}}l.AsyncStore=X,l.BaseStore=v,l.BrowserCache=G,l.StoreResult=p,l.SyncStore=E,l.registerStore=I,Object.defineProperties(l,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
