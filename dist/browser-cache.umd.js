(function(c,a){typeof exports=="object"&&typeof module!="undefined"?a(exports):typeof define=="function"&&define.amd?define(["exports"],a):(c=typeof globalThis!="undefined"?globalThis:c||self,a(c.BrowserCache={}))})(this,function(c){"use strict";var Y=Object.defineProperty,z=Object.defineProperties;var H=Object.getOwnPropertyDescriptors;var G=Object.getOwnPropertySymbols;var Q=Object.prototype.hasOwnProperty,W=Object.prototype.propertyIsEnumerable;var C=(c,a,h)=>a in c?Y(c,a,{enumerable:!0,configurable:!0,writable:!0,value:h}):c[a]=h,y=(c,a)=>{for(var h in a||(a={}))Q.call(a,h)&&C(c,h,a[h]);if(G)for(var h of G(a))W.call(a,h)&&C(c,h,a[h]);return c},P=(c,a)=>z(c,H(a));var d=(c,a,h)=>(C(c,typeof a!="symbol"?a+"":a,h),h);var a={driver:"memory"};function h(i){return{all:i=i||new Map,on:function(r,e){var s=i.get(r);s?s.push(e):i.set(r,[e])},off:function(r,e){var s=i.get(r);s&&(e?s.splice(s.indexOf(e)>>>0,1):i.set(r,[]))},emit:function(r,e){var s=i.get(r);s&&s.slice().map(function(t){t(e)}),(s=i.get("*"))&&s.slice().map(function(t){t(r,e)})}}}class T{constructor(){d(this,"mitt",new h)}get all(){return this.mitt.all}$on(){return this.mitt.on.apply(this,arguments)}$off(){return this.mitt.off.apply(this,arguments)}$emit(){return this.mitt.emit.apply(this,arguments)}}class x extends T{constructor(e={}){super();d(this,"opts");d(this,"isReady",!1);this.opts=e,this.isReady=!1}existsKey(){return Promise.reject(new Error("please implement the existsKey method for this driver."))}get(){throw new Error("please implement the get method for this driver.")}set(){throw new Error("please implement the set method for this driver.")}}const S={OK:Symbol("OK"),KEY_NOT_EXISTS:Symbol("KEY_NOT_EXISTS"),KEY_EXPIRED:Symbol("KEY_EXPIRED"),JSON_PARSE_ERROR:Symbol("JSON_PARSE_ERROR"),NX_SET_NOT_PERFORMED:Symbol("NX_SET_NOT_PERFORMED"),XX_SET_NOT_PERFORMED:Symbol("XX_SET_NOT_PERFORMED")};class O extends x{constructor(r){super(r),this.isReady=!0,this.$emit("ready")}keyValueGet(){throw new Error("please implement the keyValueGet method for this driver.")}keyValueSet(){throw new Error("please implement the keyValueSet method for this driver.")}existsKey(){throw new Error("please implement the existsKey method for this driver.")}get(r){const e=this.keyValueGet(r);if(e)try{const s=JSON.parse(e);if(s.expiredAt){if(s.expiredAt>Date.now())return s.value;this.$emit("cacheExpired",r);return}else return s.value}catch(s){window.console.debug("get key json parse error",s);return}}set(r,e,s={}){const{EX:t,PX:o,EXAT:n,PXAT:u,NX:f=!1,XX:w=!1,GET:m=!1}=s;let l,b;if(t&&typeof t=="number"&&t>0&&(l=Date.now()+t*1e3),o&&typeof o=="number"&&o>0&&(l=Date.now()+o),n&&typeof n=="number"&&n>0&&(l=n*1e3),u&&typeof u=="number"&&u>0&&(l=u),l&&(b=Math.max(l-Date.now(),0)),f||w||m){const p=this.get(r),E=this.existsKey(r);return f&&E?m?p:S.NX_SET_NOT_PERFORMED:w&&!E?m?p:S.XX_SET_NOT_PERFORMED:(this.keyValueSet(r,JSON.stringify({value:e,expiredAt:l,maxAge:b})),m?p:S.OK)}else return this.keyValueSet(r,JSON.stringify({value:e,expiredAt:l,maxAge:b})),S.OK}}class V extends O{keyValueGet(r){return localStorage.getItem(r)}keyValueSet(r,e){localStorage.setItem(r,e)}existsKey(r){return!!localStorage.getItem(r)}}d(V,"driver","localStorage");class X extends O{constructor(){super(...arguments);d(this,"data",new Map)}keyValueGet(e){return this.data.get(e)}keyValueSet(e,s){this.data.set(e,s)}existsKey(e){return!!this.data.has(e)}}d(X,"driver","memory");class k extends O{keyValueGet(r){return sessionStorage.getItem(r)}keyValueSet(r,e){sessionStorage.setItem(r,e)}existsKey(r){return!!sessionStorage.getItem(r)}}d(k,"driver","sessionStorage");/*! js-cookie v3.0.1 | MIT */function D(i){for(var r=1;r<arguments.length;r++){var e=arguments[r];for(var s in e)i[s]=e[s]}return i}var M={read:function(i){return i[0]==='"'&&(i=i.slice(1,-1)),i.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent)},write:function(i){return encodeURIComponent(i).replace(/%(2[346BF]|3[AC-F]|40|5[BDE]|60|7[BCD])/g,decodeURIComponent)}};function N(i,r){function e(t,o,n){if(typeof document!="undefined"){n=D({},r,n),typeof n.expires=="number"&&(n.expires=new Date(Date.now()+n.expires*864e5)),n.expires&&(n.expires=n.expires.toUTCString()),t=encodeURIComponent(t).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape);var u="";for(var f in n)!n[f]||(u+="; "+f,n[f]!==!0&&(u+="="+n[f].split(";")[0]));return document.cookie=t+"="+i.write(o,t)+u}}function s(t){if(!(typeof document=="undefined"||arguments.length&&!t)){for(var o=document.cookie?document.cookie.split("; "):[],n={},u=0;u<o.length;u++){var f=o[u].split("="),w=f.slice(1).join("=");try{var m=decodeURIComponent(f[0]);if(n[m]=i.read(w,m),t===m)break}catch{}}return t?n[t]:n}}return Object.create({set:e,get:s,remove:function(t,o){e(t,"",D({},o,{expires:-1}))},withAttributes:function(t){return N(this.converter,D({},this.attributes,t))},withConverter:function(t){return N(D({},this.converter,t),this.attributes)}},{attributes:{value:Object.freeze(r)},converter:{value:Object.freeze(i)}})}var _=N(M,{path:"/"});class K extends O{keyValueGet(r){return _.get(r)}keyValueSet(r,e){_.set(r,e)}existsKey(r){return!!_.get(r)}}d(K,"driver","cookie");class A extends x{constructor(r){super(r)}keyValueGet(){return Promise.reject(new Error("please implement the keyValueGet method for this driver."))}keyValueSet(){return Promise.reject(new Error("please implement the keyValueSet method for this driver."))}existsKey(){return Promise.reject(new Error("please implement the existsKey method for this driver."))}get(r){return new Promise((e,s)=>{this.keyValueGet(r).then(t=>{if(t)try{const o=JSON.parse(t);o.expiredAt?o.expiredAt>Date.now()?e(o.value):(this.$emit("cacheExpired",r),e()):e(o.value)}catch(o){window.console.debug("get key json parse error",o),e()}else e()}).catch(t=>{s(t)})})}set(r,e,s={}){const{EX:t,PX:o,EXAT:n,PXAT:u,NX:f=!1,XX:w=!1,GET:m=!1}=s;let l,b;return t&&typeof t=="number"&&t>0&&(l=Date.now()+t*1e3),o&&typeof o=="number"&&o>0&&(l=Date.now()+o),n&&typeof n=="number"&&n>0&&(l=n*1e3),u&&typeof u=="number"&&u>0&&(l=u),l&&(b=Math.max(l-Date.now(),0)),new Promise((p,E)=>{if(f||w||m){const j=this.get(r),L=this.existsKey(r);Promise.all([j,L]).then(([v,$])=>{if(f&&$)return p(m?v:S.NX_SET_NOT_PERFORMED);if(w&&!$)return p(m?v:S.XX_SET_NOT_PERFORMED);this.keyValueSet(r,JSON.stringify({value:e,expiredAt:l,maxAge:b})).then(()=>p(m?v:S.OK)).catch(q=>{E(q)})}).catch(v=>{E(v)})}else this.keyValueSet(r,JSON.stringify({value:e,expiredAt:l,maxAge:b})).then(()=>p(S.OK)).catch(j=>{E(j)})})}}class B extends A{constructor(e){var s,t,o;super(e);d(this,"dbName","browser-cache");d(this,"objectStoreName","browser-cache");d(this,"dbVersion",1);d(this,"dbConnection");this.isReady=!1,(s=this.opts)!=null&&s.dbName&&(this.dbName=this.opts.dbName),(t=this.opts)!=null&&t.objectStoreName&&(this.objectStoreName=this.opts.objectStoreName),(o=this.opts)!=null&&o.dbVersion&&(this.dbVersion=this.opts.dbVersion),this.connectDB().then(()=>{this.initObjectStore()})}connectDB(){return new Promise((e,s)=>{const t=window.indexedDB.open(this.dbName,this.dbVersion);t.onerror=()=>{window.console.error(`Database ${this.dbName} init occurs error`,t.result),s(t.result)},t.onsuccess=()=>{this.dbConnection=t.result,window.console.debug(`Database ${this.dbName} initialised.`),e(this.dbConnection)},t.onupgradeneeded=o=>{this.dbConnection=o.target.result,window.console.debug("Database version upgraded success."),e(this.dbConnection)}})}initObjectStore(){return new Promise((e,s)=>{if(this.dbConnection)this.dbConnection.objectStoreNames.contains(this.objectStoreName)||this.dbConnection.createObjectStore(this.objectStoreName,{keyPath:"key"}),this.isReady=!0,this.$emit("ready"),e();else{const t=new Error(`Database ${this.dbName} connection is not initialised.`);window.console.error(t),s(t)}})}keyValueGet(e){return new Promise((s,t)=>{if(this.dbConnection){const o=this.dbConnection.transaction([this.objectStoreName],"readonly").objectStore(this.objectStoreName).get(e);o.onerror=()=>{window.console.error("Database keyValueGet occurs error",o.result),t(o.result)},o.onsuccess=()=>{var n;s((n=o.result)==null?void 0:n.value)}}else{const o=new Error(`Database ${this.dbName} connection is not initialised.`);window.console.error(o),t(o)}})}keyValueSet(e,s){return new Promise((t,o)=>{if(this.dbConnection){const n=this.dbConnection.transaction([this.objectStoreName],"readwrite").objectStore(this.objectStoreName).put({key:e,value:s});n.onerror=()=>{window.console.error("Database keyValueSet occurs error",n.result),o(n.result)},n.onsuccess=()=>{var u;t((u=n.result)==null?void 0:u.value)}}else{const n=new Error(`Database ${this.dbName} connection is not initialised.`);window.console.error(n),o(n)}})}existsKey(e){return new Promise((s,t)=>{if(this.dbConnection){const o=this.dbConnection.transaction([this.objectStoreName],"readonly").objectStore(this.objectStoreName).count(e);o.onerror=()=>{window.console.error("Database existsKey occurs error",o.result),t(o.result)},o.onsuccess=()=>{s(!!o.result)}}else{const o=new Error(`Database ${this.dbName} connection is not initialised.`);window.console.error(o),t(o)}})}}d(B,"driver","indexedDB");const g={};for(const i of[X,V,k,K,B])g[i.driver]=i;const R={},F=i=>{if(Object.getPrototypeOf(i)===x)if(i.driver&&typeof i.driver=="string")R[i.driver]=i;else throw new Error("please input the driver name.")},I=()=>{let i=["memory"];return window.localStorage&&g.localStorage&&i.push("localStorage"),window.sessionStorage&&g.sessionStorage&&i.push("sessionStorage"),window.document.cookie&&g.cookie&&i.push("cookie"),window.indexedDB&&g.indexedDB&&i.push("indexedDB"),i=i.concat(Object.keys(R)),i},J=i=>g[i]||R[i];class U extends T{constructor(e,s){super();d(this,"opts");d(this,"__init",!1);d(this,"driver");d(this,"store");const t=I();if(!e&&!s)s=y({},a);else if(e)if(t.includes(e))Object.prototype.toString.call(s)==="[object Object]"?s=y(P(y({},a),{driver:e}),s):s=P(y({},a),{driver:e});else if(Object.prototype.toString.call(e)==="[object Object]"&&t.includes(e.driver))s=y(y({},a),e);else throw new Error("please input the correct driver param as the first param or in the opts params.");else throw new Error("please input the driver as first param.");if(s&&s.driver)this.opts=s,this.initDriver();else throw new Error("please input the driver as first param.")}initDriver(){const e=I();if(this.opts&&this.opts.driver&&e.includes(this.opts.driver)){this.__init=!1;const s=J(this.opts.driver);this.store=new s(this.opts),this.store.$on("ready",()=>{this.__init=!0,this.driver=this.opts.driver,this.$emit("ready")})}}setDriver(e){this.opts.driver=e,this.initDriver()}existsKey(){return this.store.existsKey.apply(this.store,arguments)}get(){return this.store.get.apply(this.store,arguments)}set(){return this.store.set.apply(this.store,arguments)}}c.AsyncStore=A,c.BaseStore=x,c.BrowserCache=U,c.StoreResult=S,c.SyncStore=O,c.registerStore=F,Object.defineProperties(c,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
